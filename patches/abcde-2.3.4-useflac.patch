Index: abcde
===================================================================
--- abcde	(revision 126)
+++ abcde	(working copy)
@@ -1248,9 +1248,13 @@
 		if [ "$OSFLAVOUR" = "OSX" ]; then
 			disktool -u ${CDROM#/dev/}
 		fi
-		TRACKINFO=$($CDDISCID $CDROM)
+		if [ "$CDROMREADERSYNTAX" = "flac" ] ; then
+			TRACKINFO=$($METAFLAC $METAFLACOPTS --export-cuesheet-to=- $CDROM | cue2discid)
+		else
+			TRACKINFO=$($CDDISCID $CDROM)
+		fi
 		# Make sure there's a CD in there by checking cd-discid's return code
-		if [ "$?" = "1" ]; then
+ 		if [ "$?" != "0" ]; then
 			echo "abcde error: CD could not be read. Perhaps there's no CD in the drive?" >&2
 			exit 1
 		fi
@@ -2043,6 +2047,7 @@
 		LASTTRACK=$3
 		UTRACKNUM=$FIRSTTRACK
 		case "$CDROMREADERSYNTAX" in
+			flac) READTRACKNUMS="$FIRSTTRACK.1-$((10#$LASTTRACK + 1)).0" ;;
 			cdparanoia) READTRACKNUMS="$FIRSTTRACK-$LASTTRACK" ;;
 			cdda2wav) READTRACKNUMS="$FIRSTTRACK+$LASTRACK" ;;
 			*) echo "abcde error: $CDROMREADERSYNTAX does not support ONETRACK mode"
@@ -2060,7 +2065,10 @@
 	else
 		WAVDATA="$ABCDETEMPDIR/track$UTRACKNUM.wav"
 		case "$CDROMREADERSYNTAX" in
-		## FIXME ## Find the case for dagrab, to avoid exceptions
+		## FIXME ## Find the casea for flac and dagrab, to avoid exceptions
+			flac)
+				FILEARG="--output-name=$WAVDATA"
+				;;
 			dagrab)
 				FILEARG="-f $WAVDATA"
 				;;
@@ -2082,6 +2090,10 @@
 		fi
 	fi
 	case "$CDROMREADERSYNTAX" in
+		## FIXME ## We have an exception for flac, since it uses -o
+		## FIXME ## Shall we just use -o $FILEARG ??
+		flac)
+			nice $READNICE $FLAC -d --cue=${READTRACKNUMS:-$UTRACKNUM.1-$((10#$UTRACKNUM + 1)).0} "$FILEARG" "$CDROM" ;;
 		cdparanoia) 
 			nice $READNICE $CDROMREADER -$CDPARANOIACDROMBUS $CDROM ${READTRACKNUMS:-$UTRACKNUM} "$FILEARG" $REDIR ;;
 		cdda2wav)
@@ -2473,10 +2485,16 @@
 
 shift $(($OPTIND - 1))
 
+# If the user specified a flac file, then switch to special flac mode
+if echo $CDROM | grep -q '.flac$'; then
+	CDROMREADERSYNTAX=flac
+fi
+
 # Decide if we can continue.
 if [ "$ONETRACK" = "y" ]; then 
 	# FIXME # remove check as soon as we find out about the other readers
 	case "$CDROMREADERSYNTAX" in
+		flac) ;;
 		cdparanoia) ;;
 		cdda2wav) ;;
 		*) echo "abcde error: $CDROMREADERSYNTAX does not support ONETRACK mode"
@@ -2636,6 +2654,10 @@
 	cddafs)
 		CDROMREADER="$CDDAFS"
 		CDROMREADEROPTS="$CDDAFSOPTS"
+		;;
+	flac)
+		CDROMREADER="$FLAC"
+		CDROMREADEROPTS="$FLACOPTS"
 		;;
 esac
 
@@ -2822,6 +2844,7 @@
 if [ X"$CDSPEEDVALUE" != "X" ]; then
 	case "$CDROMREADERSYNTAX" in
 		cdparanoia|debug) CDROMREADEROPTS="$CDPARANOIAOPTS -S $CDSPEEDVALUE" ;;
+		flac) NEEDMETAFLAC=y ;;
 		*) NEEDCDSPEED=y ;;
 	esac
 fi
@@ -2829,6 +2852,7 @@
 # Rippers with USEPIPE support
 # FIXME # Include here all the rippers we can figure out support pipes
 PIPE_cdparanoia="-"
+PIPE_flac="-c"
 
 # Encoders with USEPIPE support
 # FIXME # Include here all the encoders we can figure out support pipes
@@ -2937,7 +2961,7 @@
 
 if [ X"$CDSPEEDVALUE" != "X" ]; then
 	case "$CDROMREADERSYNTAX" in
-		cdparanoia|debug) : ;;
+		cdparanoia|flac|debug) : ;;
 		*) do_cdspeed ;;
 	esac
 fi
